name: Rollback Detection Rules

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - development
          - production
      rollback_type:
        description: 'Type of rollback'
        required: true
        type: choice
        options:
          - last_known_good
          - specific_commit
      commit_sha:
        description: 'Specific commit SHA (only for specific_commit type)'
        required: false
        type: string

jobs:
  rollback:
    runs-on: ubuntu-latest
    name: Rollback Detection Rules
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Get full history for rollback

    - name: Validate inputs
      run: |
        if [ "${{ inputs.rollback_type }}" == "specific_commit" ] && [ -z "${{ inputs.commit_sha }}" ]; then
          echo "❌ Error: Commit SHA is required for specific_commit rollback type"
          exit 1
        fi

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install detection-rules dependencies
      run: |
        python -m pip install --upgrade pip
        pip install .[dev]
        pip install lib/kibana
        pip install lib/kql

    - name: Determine rollback target
      id: rollback_target
      run: |
        if [ "${{ inputs.rollback_type }}" == "last_known_good" ]; then
          # Find the last successful deployment commit
          # Look for commits with successful workflow runs
          echo "Finding last known good deployment..."
          
          # Get the last 10 commits that modified custom-rules
          COMMITS=$(git log --pretty=format:"%H" -n 10 -- custom-rules/)
          
          for commit in ${COMMITS}; do
            # Check if this commit had a successful workflow run
            # For now, we'll use the second-to-last commit as a simple approach
            # In production, you'd query GitHub API for successful workflow runs
            if [ "${commit}" != "${{ github.sha }}" ]; then
              echo "rollback_commit=${commit}" >> $$GITHUB_OUTPUT
              echo "Found rollback target: ${commit}"
              break
            fi
          done
        else
          # Use specific commit
          echo "rollback_commit=${{ inputs.commit_sha }}" >> $$GITHUB_OUTPUT
          echo "Using specific commit: ${{ inputs.commit_sha }}"
        fi

    - name: Export current rules (backup)
      env:
        ELASTIC_CLOUD_ID: ${{ inputs.environment == 'production' && secrets.PROD_ELASTIC_CLOUD_ID || secrets.DEV_ELASTIC_CLOUD_ID }}
        ELASTIC_API_KEY: ${{ inputs.environment == 'production' && secrets.PROD_ELASTIC_API_KEY || secrets.DEV_ELASTIC_API_KEY }}
      run: |
        echo "Creating backup of current rules..."
        
        # Create detection-rules config file
        cat > .detection-rules-cfg.json << EOF
        {
          "cloud_id": "${ELASTIC_CLOUD_ID}",
          "api_key": "${ELASTIC_API_KEY}"
        }
        EOF
        
        # Export current rules as backup
        mkdir -p rollback-backup
        python -m detection_rules kibana export-rules \
          -d rollback-backup/ \
          --space default || echo "Warning: Some rules may have failed to export"
        
        # Store backup info
        echo "Backup created at: $$(date -u '+%Y-%m-%d %H:%M:%S UTC')" > rollback-backup/backup-info.txt
        echo "Environment: ${{ inputs.environment }}" >> rollback-backup/backup-info.txt
        echo "Original commit: ${{ github.sha }}" >> rollback-backup/backup-info.txt

    - name: Checkout rollback commit
      run: |
        echo "Checking out rollback commit: ${{ steps.rollback_target.outputs.rollback_commit }}"
        git checkout ${{ steps.rollback_target.outputs.rollback_commit }}

    - name: Validate rollback rules
      run: |
        if [ -d "custom-rules/rules" ] && [ "$(ls -A custom-rules/rules)" ]; then
          echo "Validating rollback rules..."
          python -m detection_rules validate-rule custom-rules/rules/*.toml
          python -m detection_rules test custom-rules/rules/
          echo "✅ Rollback rules validated successfully"
        else
          echo "No custom rules found at rollback commit"
        fi

    - name: Deploy rollback rules
      env:
        ELASTIC_CLOUD_ID: ${{ inputs.environment == 'production' && secrets.PROD_ELASTIC_CLOUD_ID || secrets.DEV_ELASTIC_CLOUD_ID }}
        ELASTIC_API_KEY: ${{ inputs.environment == 'production' && secrets.PROD_ELASTIC_API_KEY || secrets.DEV_ELASTIC_API_KEY }}
      run: |
        echo "🔄 Rolling back ${{ inputs.environment }} environment..."
        
        # Create detection-rules config file
        cat > .detection-rules-cfg.json << EOF
        {
          "cloud_id": "${ELASTIC_CLOUD_ID}",
          "api_key": "${ELASTIC_API_KEY}"
        }
        EOF
        
        if [ -d "custom-rules/rules" ] && [ "$(ls -A custom-rules/rules)" ]; then
          # Import rollback rules
          python -m detection_rules kibana import-rules \
            -d custom-rules/rules/ \
            --space default \
            --overwrite
          
          echo "✅ Rollback completed successfully!"
        else
          echo "⚠️ No rules to rollback to - environment may need manual restoration"
        fi
        
        # Clean up config file
        rm -f .detection-rules-cfg.json

    - name: Create rollback record
      if: always()
      env:
        GH_TOKEN: ${{ secrets.GH_PAT }}
      run: |
        # Create an issue to track the rollback
        gh issue create \
          --title "🔄 Rollback: ${{ inputs.environment }} environment" \
          --body "## Rollback Record
        
        ### Rollback Details
        - **Environment**: ${{ inputs.environment }}
        - **Rollback Type**: ${{ inputs.rollback_type }}
        - **Rolled back to**: ${{ steps.rollback_target.outputs.rollback_commit }}
        - **Triggered by**: ${{ github.actor }}
        - **Time**: $$(date -u '+%Y-%m-%d %H:%M:%S UTC')
        
        ### Status
        - **Result**: ${{ job.status }}
        
        ### Action Required
        - Review the rollback and determine root cause
        - Fix the issue that caused the need for rollback
        - Re-deploy fixed rules when ready
        
        ### Backup Location
        The pre-rollback rules were backed up and can be found in the workflow artifacts.
        
        ---
        *This issue was automatically created by the rollback workflow.*" \
          --label "rollback,${{ inputs.environment }}"

    - name: Upload backup artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: rollback-backup-${{ inputs.environment }}-${{ github.run_id }}
        path: rollback-backup/
        retention-days: 30

    - name: Generate rollback summary
      if: always()
      run: |
        echo "## 🔄 Rollback Summary" >> $$GITHUB_STEP_SUMMARY
        echo "" >> $$GITHUB_STEP_SUMMARY
        echo "### Rollback Information" >> $$GITHUB_STEP_SUMMARY
        echo "- **Environment**: ${{ inputs.environment }}" >> $$GITHUB_STEP_SUMMARY
        echo "- **Type**: ${{ inputs.rollback_type }}" >> $$GITHUB_STEP_SUMMARY
        echo "- **Target Commit**: ${{ steps.rollback_target.outputs.rollback_commit }}" >> $$GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ job.status }}" >> $$GITHUB_STEP_SUMMARY
        echo "" >> $$GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "### ✅ Rollback Successful" >> $$GITHUB_STEP_SUMMARY
          echo "" >> $$GITHUB_STEP_SUMMARY
          echo "The ${{ inputs.environment }} environment has been rolled back successfully." >> $$GITHUB_STEP_SUMMARY
          echo "An issue has been created to track this rollback." >> $$GITHUB_STEP_SUMMARY
        else
          echo "### ❌ Rollback Failed" >> $$GITHUB_STEP_SUMMARY
          echo "" >> $$GITHUB_STEP_SUMMARY
          echo "The rollback encountered errors. Manual intervention may be required." >> $$GITHUB_STEP_SUMMARY
        fi
